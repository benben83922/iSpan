<!-- "sno": "500101185",
租賃站點查詢     "sna": "YouBike2.0_辛亥新生路口西北側",
                "sarea": "大安區",
                "mday": "2025-11-11 13:39:02",
站點位置         "ar": "辛亥路一段/新生南路三段(西北側)",
                "sareaen": "Daan Dist.",
                "snaen": "YouBike2.0_Xinhai Rd. & Xinsheng S. Rd. Intersection",
地址            "aren": "Sec. 1， Xinhai Rd. & Sec. 3， Xinsheng S. Rd. Intersection (Northwest)",
                "act": "1",
                "srcUpdateTime": "2025-11-11 13:39:29",
更新時間         "updateTime": "2025-11-11 13:39:52",
                "infoTime": "2025-11-11 13:39:02",
日期             "infoDate": "2025-11-11",
總位置數         "Quantity": 40,
可借車輛         "available_rent_bikes": 12,
緯度             "latitude": 25.02267,
經度             "longitude": 121.5341,
可停空位         "available_return_bikes": 28 -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- <meta http-equiv="Refresh" content="10;"> -->
    <!-- leaflet css 設定 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- 自訂 css -->
    <style>
        table {
            margin: 0 auto;
            /* ✅ 這行讓整個表格水平置中 */
            text-align: center;
            /* 表格內容置中（可選） */
        }

        thead,
        th,
        tbody,
        tr,
        td {
            border: 1px solid;
        }

        #map {
            height: 480px;
        }

        button {
            margin-right: 20px;
            float: left;
        }

        p {
            color: #000000;
            font-size: 20px;
            margin-left: 20px;
        }
    </style>
</head>

<body>
    <button id="btn_request">取得臺北市ubike列表</button>
    <button id="stop-btn">停止更新</button>
    <p>
        依照有無可租借車輛及有無可歸還車位賦予不同icon，並在滑鼠移至無車可借/無車位可歸還的站點icon時彈出提示
    </p>

    <h2 id="times">更新次數(10秒一次)：</h2>

    <div id="map"></div>

    <table>
        <thead>
            <tr>
                <th>租賃站點</th>
                <th>站點位置</th>
                <th>更新時間</th>
                <th>總位置數</th>
                <th>可借車輛</th>
                <th>可停空位</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
        integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg=" crossorigin=""></script>
    <script>
        var map = L.map('map').setView([25.0339145, 121.5412233], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let count = 0;
        let updateInterval = null; // 儲存 setInterval 的 ID
        let layerGroup = null;
        let arrLayers = [];

        async function updateTable() {
            const response = await fetch('http://127.0.0.1:5000/youbike');
            const data = await response.json();

            if (layerGroup != null) {
                layerGroup.clearLayers();
                map.removeLayer(layerGroup);

                //變數初始化
                layerGroup = null;
                arrLayers = [];
            }

            // 取得 tbody 元素
            let tbody = document.querySelector('table > tbody');

            // 清空 tbody 底下既有元素，如 tr td 等
            tbody.innerHTML = '';

            // 將回傳資料動態生成在網頁上
            for (let o of data) {
                //輸出對應的 html tag
                let tr = document.createElement("tr");
                tr.innerHTML = `<td>${o['sna']}</td>
                                    <td>${o['ar']}</td>
                                    <td>${o['updateTime']}</td>
                                    <td>${o['Quantity']}</td>
                                    <td>${o['available_rent_bikes']}</td>
                                    <td>${o['available_return_bikes']}</td>`;
                tbody.appendChild(tr);

                const customIcon_red = L.icon({
                    iconUrl: 'pin_red.png', // 這裡放你的 icon 圖片 URL
                    iconSize: [40, 40], // 圖示大小（寬, 高）
                    iconAnchor: [20, 40], // 圖示錨點（通常在底部中心）
                    popupAnchor: [0, -40] // popup 相對於 icon 的位置
                });

                const customIcon_orange = L.icon({
                    iconUrl: 'pin_orange.png', // 這裡放你的 icon 圖片 URL
                    iconSize: [30, 30], // 圖示大小（寬, 高）
                    iconAnchor: [20, 40], // 圖示錨點（通常在底部中心）
                    popupAnchor: [0, -40] // popup 相對於 icon 的位置
                });

                const customIcon_blue = L.icon({
                    iconUrl: 'pin_blue.png', // 這裡放你的 icon 圖片 URL
                    iconSize: [20, 20], // 圖示大小（寬, 高）
                    iconAnchor: [20, 40], // 圖示錨點（通常在底部中心）
                    popupAnchor: [0, -40] // popup 相對於 icon 的位置
                });

                let marker;

                if (o['available_rent_bikes'] == '0') {
                    //建立 markers
                    marker = L.marker([o['latitude'], o['longitude']], { icon: customIcon_red })
                        .bindPopup(`<h3>無可借車輛！<h3>租賃站點：${o['sna']}<br>站點位置：${o['ar']}<br>可借車輛：${o['available_rent_bikes']}<br>可停空位：${o['available_return_bikes']}<br>更新時間：${o['updateTime']}`);
                    marker.bindTooltip('無可借車輛！');
                }
                else if (o['available_return_bikes'] == '0') {
                    //建立 markers
                    marker = L.marker([o['latitude'], o['longitude']], { icon: customIcon_orange })
                        .bindPopup(`租賃站點：${o['sna']}<br>站點位置：${o['ar']}<br>可借車輛：${o['available_rent_bikes']}<br>可停空位：${o['available_return_bikes']}<br>更新時間：${o['updateTime']}`);
                    marker.bindTooltip('無空位可歸還！');
                }
                else {
                    //建立 markers
                    marker = L.marker([o['latitude'], o['longitude']], { icon: customIcon_blue })
                        .bindPopup(`租賃站點：${o['sna']}<br>站點位置：${o['ar']}<br>可借車輛：${o['available_rent_bikes']}<br>可停空位：${o['available_return_bikes']}<br>更新時間：${o['updateTime']}`);
                }

                //自訂事件
                marker.addEventListener('click', function (event) {
                    console.log(o);
                });

                //將 markers 各別放到空陣列 arrLayers 當中
                arrLayers.push(marker);
            }

            //迴圈執行完畢後，將 arrLayers 放到 layerGroup 當中
            layerGroup = L.layerGroup(arrLayers);

            //將 layerGroup 放到 map 當中
            layerGroup.addTo(map);
            count += 1;
            const times = document.getElementById('times');

            // 修改文字內容
            times.textContent = '更新次數(10秒一次)：' + count;
        }

        document.querySelector('button#btn_request').addEventListener('click', () => {
            if (updateInterval) return; // 防止重複啟動
            if (count > 0) {
                count = 0;
                const times = document.getElementById('times');
                times.textContent = '更新次數(10秒一次)：';
            }
            updateTable(); // 先更新一次
            updateInterval = setInterval(updateTable, 10000); // 每 10 秒更新一次
            document.getElementById('btn_request').disabled = true; // 禁用按鈕避免重複點擊
            document.getElementById('start-btn').textContent = '自動更新中...';
        })

        document.getElementById('stop-btn').addEventListener('click', () => {
            document.getElementById('btn_request').disabled = false;
            clearInterval(updateInterval);
            updateInterval = null;
        });


        // // L.marker([25.0339145, 121.5412233]).addTo(map)
        // //     .bindPopup('自訂訊息<br>可以放 HTML')
        // //     .openPopup();
        // //設定圖層群組
        // let layerGroup = null;
        // let arrLayers = [];

        // // 按鈕事件，取得 Web API 的回傳資料
        // document.querySelector('button#btn_request').addEventListener('click', function (event) {
        //     /**
        //      * 非同步傳輸的工具 - fetch
        //      * 透過 ajax (xml http request) 技術，
        //      * 做到不切換頁面也能請求資料/取得回應的方法
        //      *
        //      * 參考網頁:
        //      * 1. 鐵人賽：ES6 原生 Fetch 遠端資料方法
        //      * https://www.casper.tw/javascript/2017/12/28/javascript-fetch/
        //      */
        //     fetch('http://127.0.0.1:5000/youbike', {
        //         //設定請求方法
        //         method: "GET"
        //     }).then(function (response) {
        //         /**
        //          * response.text() - 純文字 or html
        //          * response.blob() - 通常用於 base64 編碼後的 img 內容
        //          * response.json() - 若回傳的格式為 json 文字，自動轉成物件 (Object)
        //          */
        //         return response.json();
        //     }).then(function (arr) {
        //         //刪除先前的 markers
        //         if (layerGroup != null) {
        //             layerGroup.clearLayers();
        //             map.removeLayer(layerGroup);

        //             //變數初始化
        //             layerGroup = null;
        //             arrLayers = [];
        //         }

        //         // 取得 tbody 元素
        //         let tbody = document.querySelector('table > tbody');

        //         // 清空 tbody 底下既有元素，如 tr td 等
        //         tbody.innerHTML = '';

        //         // 將回傳資料動態生成在網頁上
        //         for (let o of arr) {
        //             //輸出對應的 html tag
        //             let tr = document.createElement("tr");
        //             tr.innerHTML = `<td>${o['sna']}</td>
        //                             <td>${o['ar']}</td>
        //                             <td>${o['updateTime']}</td>
        //                             <td>${o['Quantity']}</td>
        //                             <td>${o['available_rent_bikes']}</td>
        //                             <td>${o['available_return_bikes']}</td>`;
        //             tbody.appendChild(tr);

        //             //建立 markers
        //             let marker = L.marker([o['latitude'], o['longitude']])
        //                 .bindPopup(`${o['sna']}<br><a href="${o['url']}" target="_blank">連結</a>`);

        //             //自訂事件
        //             marker.addEventListener('click', function (event) {
        //                 console.log(o);
        //             });

        //             //將 markers 各別放到空陣列 arrLayers 當中
        //             arrLayers.push(marker);
        //         }

        //         //迴圈執行完畢後，將 arrLayers 放到 layerGroup 當中
        //         layerGroup = L.layerGroup(arrLayers);

        //         //將 layerGroup 放到 map 當中
        //         layerGroup.addTo(map);
        //     });
        // });
    </script>
</body>

</html>